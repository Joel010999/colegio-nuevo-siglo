{% extends 'portal/base.html' %}
{% load static %}

{% block title %}Consulta de Deudas{% endblock %}

{% block content %}
<div class="container" style="max-width:1000px">
    <!-- Header -->
    <div class="header" style="text-align:center">
        <div style="width:100%">
            <h1 style="justify-content:center">
                <img src="{% static 'portal/logo.jpg' %}" alt="Logo" class="logo" onerror="this.style.display='none'">
                Colegio Nuevo Siglo
            </h1>
            <p style="opacity:0.9">Portal de Consulta de Estados de Cuenta</p>
        </div>
    </div>

    <!-- Formulario de b√∫squeda -->
    <div class="card">
        <form method="GET" action="{% url 'portal:consulta_publica' %}" class="filters" style="align-items:flex-end;">
            <div class="form-group" style="margin-bottom:0">
                <label for="dni">üîç Ingrese DNI del Alumno o Responsable</label>
                <input type="text" id="dni" name="dni" placeholder="Ej: 12345678" value="{{ dni_buscado }}"
                    pattern="[0-9]+" title="Ingrese solo n√∫meros" required>
            </div>
            <button type="submit" class="btn btn-primary btn-block-mobile">Consultar</button>
        </form>
    </div>

    {% if busqueda_realizada %}
    {% if mensaje_error %}
    <!-- Mensaje de error -->
    <div class="alert alert-error">
        ‚ö†Ô∏è {{ mensaje_error }}
    </div>
    {% elif alumnos %}
    <!-- Total General -->
    <div class="total-box">
        <p>Deuda Total Pendiente</p>
        <h2>${{ total_adeudado|floatformat:0|default:"0" }}</h2>
    </div>

    <!-- Listado de alumnos con sus deudas -->
    {% for data in alumnos %}
    <div class="card" style="margin-bottom:1.5rem">
        <div
            style="background:linear-gradient(135deg, #f8f9fa, #e9ecef);padding:1rem;margin:-1.5rem -1.5rem 1rem;border-radius:12px 12px 0 0">
            <h3 style="color:var(--primary);margin-bottom:0.25rem">{{ data.alumno.nombre_completo }}</h3>
            <p style="color:var(--text-light);font-size:0.875rem">DNI: {{ data.alumno.documento }} | {{
                data.alumno.curso_completo }}</p>
        </div>

        {% if data.deudas %}
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Monto</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for deuda in data.deudas %}
                    <tr>
                        <td>{{ deuda.concepto.nombre }}</td>
                        <td>${{ deuda.monto|floatformat:0 }}</td>
                        <td>
                            {% if deuda.estado == 'pendiente' %}
                            <span class="badge badge-pending">‚è≥ Pendiente</span>
                            {% elif deuda.estado == 'pago_verificado' or deuda.estado == 'pagado' %}
                            <span class="badge badge-verified">‚úÖ Pagado</span>
                            {% else %}
                            <span class="badge">{{ deuda.get_estado_display }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="text-align:center;color:var(--text-light)">No hay registros de deuda</p>
        {% endif %}

        <div
            style="background:var(--bg);padding:1rem;border-radius:8px;margin-top:1rem;display:flex;justify-content:space-between;align-items:center">
            <span>Subtotal pendiente:</span>
            <strong style="font-size:1.25rem;color:var(--primary)">${{ data.total|floatformat:0|default:"0" }}</strong>
        </div>
    </div>
    {% endfor %}

    <!-- Informaci√≥n de pago -->
    <div class="alert alert-info">
        <strong>üìã Para realizar el pago</strong><br>
        Ingrese al sistema con su DNI para cargar comprobantes de pago.<br>
        <a href="{% url 'portal:login' %}" class="btn btn-primary btn-sm" style="margin-top:0.5rem">Iniciar sesi√≥n ‚Üí</a>
    </div>

    {% else %}
    <!-- Sin resultados -->
    <div class="card" style="text-align:center;padding:3rem">
        <p style="font-size:3rem;margin-bottom:1rem">üîç</p>
        <h3>No se encontraron resultados</h3>
        <p style="color:var(--text-light)">No hay registros asociados al DNI ingresado</p>
    </div>
    {% endif %}
    {% else %}
    <!-- Estado inicial -->
    <div class="card" style="text-align:center;padding:3rem">
        <p style="font-size:3rem;margin-bottom:1rem">üîç</p>
        <h3>Consulte su Estado de Cuenta</h3>
        <p style="color:var(--text-light)">Ingrese el DNI del alumno o de cualquier responsable (padre, madre o tutor)
            para ver las deudas pendientes.</p>
    </div>
    {% endif %}
</div>

<!-- Footer -->
<footer style="text-align: center; padding: 2rem; color: var(--text-light); font-size: 0.875rem;">
    <p><a href="https://renderbyte.net" target="_blank" style="color: inherit; text-decoration: none;">RenderByte |
            Todos los derechos Reservados.</a></p>
</footer>
{% endblock %}